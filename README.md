# LaborControl（LOGI-MATRIX）

このプロジェクトは **Google スプレッドシート + Apps Script** で、
現場スタッフの配置管理を行うためのツールです。

初めて触る方向けに、
- 何をどこで操作するか
- どのシートが何の役割か
- 日々の運用手順
を先に読めるように整理しています。

---

## 1. 画面と機能の全体像

### スプレッドシート上のメニュー
スプレッドシートを開くと、上部メニューに **「🚚 配置システム」** が表示されます。

- **配置反映 (色付きセル)**
  - `配置表` シートで使う反映機能です。
  - 確認ダイアログが出たあと、`executePaste()` が実行されます。
- **配置管理パネルを開く**
  - LOGI-MATRIX のドラッグ＆ドロップ UI（`index.html`）を開きます。

### LOGI-MATRIX（配置管理パネル）
パネルでは次の操作ができます。

- スタッフを **Pool ⇔ 各エリア** へドラッグ＆ドロップ
- 検索（名前／所属）
- 並び替え（Pool）
- 自動配置（メイン業務ベース）
- 保存（割り当てシートへ反映）
- Undo / Redo

---

## 2. シート構成（最低限ここだけ把握）

- `割り当て`
  - 配置の保存先。
  - パネルの「保存」でここに書き込みます。
- `スタッフマスタ`
  - 氏名、所属、メイン業務などの基礎情報。
  - 自動配置で参照します。
- `作業マスタ`
  - エリア設定、作業カテゴリ、プルダウン候補の参照元。
- `会社マスタ`
  - 会社名と色の対応。
- `配置表`
  - 現場の配置反映対象シート。

---

## 3. 日次運用（まずはこの順番）

1. **マスタを整える**
   - 新しい作業・エリア・スタッフがある場合は、各マスタを更新。
2. **配置管理パネルを開く**
   - メニュー `🚚 配置システム > 配置管理パネルを開く`。
3. **配置を調整する**
   - 必要に応じて検索、並び替え、自動配置を実行。
4. **保存する**
   - 「保存」ボタンで `割り当て` シートへ反映。
5. **配置表へ反映する**
   - `配置表` シートに移動し、`配置反映 (色付きセル)` を実行。

---

## 4. よく使う機能

### A. 自動配置（メイン業務）
- 「自動配置」ボタンを押すと、`スタッフマスタ` のメイン業務と
  エリア名のマッチングで自動的に振り分けます。
- マッチしない業務名がある場合は件数をトースト表示します。

### B. 保存時の未知スタッフ確認
- 保存時、`割り当て` シートの有効スタッフに存在しない名前があると確認ダイアログを表示。
- 「削除して保存」または「残して保存」を選べます。

### C. 配置表反映
- `配置表` シートのみで実行可能。
- 作業マスタの工程→作業カテゴリ辞書を使い、`I列` と `DB～` の値を参照して `J～DA` に反映します。

---

## 5. コード構成（今回の整理後）

### サーバーサイド（.gs）
- `AppConfig.gs`
  - 定数（シート名、UIサイズ、貼り付け範囲など）
- `ToolbarMenu.gs`
  - onOpen、メニュー表示、HTMLテンプレート include
- `LayoutReflection.gs`
  - 配置表反映、OCR処理
- `AssignmentLogic.gs`
  - LOGI-MATRIX の割り当て取得・自動配置・保存
- `CONFIG.gs`
  - マスタ設定（ドロップダウン・色連動・マスタ読み取り）
- `配置.gs`
  - 旧ファイル（移行案内のみ）

### フロントエンド（HTML）
- `index.html`
  - 画面の土台。部分ファイルを include
- `indexStyles.html`
  - スタイル
- `indexToolbarButtons.html`
  - ツールバーのボタンHTML
- `indexScriptMain.html`
  - 画面描画、ドラッグ＆ドロップ、検索、並び替え
- `indexScriptToolbarButtons.html`
  - ツールバーのボタン処理（保存・自動配置・Undo/Redo）
- `confirmDialog.html`
  - 配置反映の確認ダイアログ

---

## 6. 初期セットアップ時の確認ポイント

- Apps Script プロジェクトにこのファイル群を配置
- `CONFIG.OCR_FOLDER_ID`（`AppConfig.gs`）を必要に応じて設定
- スプレッドシートのシート名が定義と一致しているか確認
  - `割り当て / スタッフマスタ / 作業マスタ / 会社マスタ / 配置表`
- メニュー「🚚 配置システム」が表示されるか確認

---

## 7. トラブルシュート

- **「この機能は配置表シートのみ」エラー**
  - `配置表` シートをアクティブにしてから実行してください。
- **自動配置が期待通りでない**
  - `スタッフマスタ` のメイン業務名と、`作業マスタ` のエリア名の表記ゆれを確認。
- **色が反映されない**
  - `作業マスタ` 側の候補セル（G列・Q列）の背景色/文字色が設定されているか確認。


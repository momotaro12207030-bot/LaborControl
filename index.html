<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6 text-slate-800">
  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6 space-y-6">
    <div>
      <h1 class="text-2xl font-bold">人員配置・進捗管理ダッシュボード</h1>
      <p class="text-sm text-slate-500">Google Sheets 上のシフト・配置・進捗を一括管理します。</p>
    </div>

    <div class="grid sm:grid-cols-[180px_1fr] gap-3 items-center">
      <label for="targetDate" class="text-sm font-semibold">対象日付</label>
      <input id="targetDate" type="date" class="border rounded-lg px-3 py-2 w-full" />
    </div>

    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
      <button id="btnAttendance" onclick="generateAttendanceForDate()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg px-4 py-3">今日の出勤者を生成</button>
      <button id="btnAssign" onclick="assignWorkForDate()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg px-4 py-3">作業割り振り</button>
      <button id="btnMetrics" onclick="loadMetrics()" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-lg px-4 py-3">スループット表示</button>
      <button id="btnProductivity" onclick="calculateProductivityForDate()" class="bg-violet-600 hover:bg-violet-700 text-white font-semibold rounded-lg px-4 py-3">個人別生産性を計算</button>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="border rounded-xl p-4">
        <h2 class="font-semibold mb-2">スループット</h2>
        <p id="throughputText" class="text-sm text-slate-600">未計算</p>
      </div>
      <div class="border rounded-xl p-4">
        <h2 class="font-semibold mb-2">進捗状況</h2>
        <p id="progressText" class="text-sm text-slate-600">未計算</p>
      </div>
    </div>

    <div>
      <h2 class="font-semibold mb-2">処理ログ</h2>
      <pre id="log" class="bg-slate-900 text-slate-100 text-xs rounded-xl p-4 h-52 overflow-auto"></pre>
    </div>
  </div>

  <script>
    function setToday() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('targetDate').value = `${yyyy}-${mm}-${dd}`;
    }

    function getTargetDate() {
      const value = document.getElementById('targetDate').value;
      if (!value) {
        throw new Error('対象日付を選択してください。');
      }
      return value;
    }

    function appendLog(message) {
      const log = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      log.textContent = `[${time}] ${message}\n` + log.textContent;
    }

    function callServer(functionName, args, onSuccess) {
      google.script.run
        .withSuccessHandler((res) => {
          onSuccess(res);
        })
        .withFailureHandler((err) => {
          appendLog(`エラー: ${err.message}`);
        })[functionName].apply(google.script.run, args);
    }

    function generateAttendanceForDate() {
      try {
        const date = getTargetDate();
        google.script.run
          .withSuccessHandler((res) => {
            appendLog(res.message || `出勤者生成完了: ${res.count || 0}名`);
          })
          .withFailureHandler((err) => appendLog(`エラー: ${err.message}`))
          .generateAttendance(date);
      } catch (e) {
        appendLog(e.message);
      }
    }

    function assignWorkForDate() {
      try {
        const date = getTargetDate();
        google.script.run
          .withSuccessHandler((res) => {
            appendLog(res.message || `割り振り完了: ${res.count || 0}件`);
          })
          .withFailureHandler((err) => appendLog(`エラー: ${err.message}`))
          .assignWork(date);
      } catch (e) {
        appendLog(e.message);
      }
    }

    function loadMetrics() {
      try {
        const date = getTargetDate();
        google.script.run
          .withSuccessHandler((res) => {
            const text = `日付: ${res.date} / 合計TP: ${res.totalThroughput}`;
            document.getElementById('throughputText').textContent = text;
            appendLog(`スループット計算完了: ${text}`);
          })
          .withFailureHandler((err) => appendLog(`エラー: ${err.message}`))
          .calculateThroughput(date);

        google.script.run
          .withSuccessHandler((res) => {
            const text = `実績: ${res.actual} / 目標: ${res.target} / 差分: ${res.diff}`;
            document.getElementById('progressText').textContent = text;
            appendLog(`進捗取得完了: ${text}`);
          })
          .withFailureHandler((err) => appendLog(`エラー: ${err.message}`))
          .calculateProgress(date);
      } catch (e) {
        appendLog(e.message);
      }
    }

    function calculateProductivityForDate() {
      try {
        const date = getTargetDate();
        google.script.run
          .withSuccessHandler((res) => {
            appendLog(`個人別生産性を更新: ${res.count || 0}件`);
          })
          .withFailureHandler((err) => appendLog(`エラー: ${err.message}`))
          .calculateProductivity(date);
      } catch (e) {
        appendLog(e.message);
      }
    }

    setToday();
  </script>
</body>
</html>
